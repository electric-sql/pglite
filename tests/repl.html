<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>PG SHELL TEST</title>
    <style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      textarea.emscripten { font-family: monospace; width: 80%; }
      div.emscripten { text-align: center; }
      div.emscripten_border { border: 1px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { border: 0px none; background-color: black; }

      .spinner {
        height: 50px;
        width: 50px;
        margin: 0px auto;
        -webkit-animation: rotation .8s linear infinite;
        -moz-animation: rotation .8s linear infinite;
        -o-animation: rotation .8s linear infinite;
        animation: rotation 0.8s linear infinite;
        border-left: 10px solid rgb(0,150,240);
        border-right: 10px solid rgb(0,150,240);
        border-bottom: 10px solid rgb(0,150,240);
        border-top: 10px solid rgb(100,0,200);
        border-radius: 100%;
        background-color: rgb(200,100,250);
      }
      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }

    </style>

    <link rel="prefetch" href="./vtx.js">
    <link rel="prefetch" href="https://pygame-web.github.io/archives/0.9/vt/xterm.js">
    <link rel="prefetch" href="https://pygame-web.github.io/archives/0.9/vt/xterm-addon-image.js">

  </head>
  <body>
    <hr/>
    <figure style="overflow:visible;" id="spinner"><div class="spinner"></div><center style="margin-top:0.5em"><strong>emscripten</strong></center></figure>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>

    <div class="emscripten_border" hidden>
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    </div>

    <hr/>
    <div class="emscripten" hidden>
      <input type="checkbox" id="resize">Resize canvas
      <input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer
      &nbsp;&nbsp;&nbsp;
      <input type="button" value="Fullscreen" onclick="Module.requestFullscreen(document.getElementById('pointerLock').checked,
                                                                                document.getElementById('resize').checked)">
    </div>

    <div id="repl"></div>

    <hr/>
    <textarea class="emscripten" id="output" rows="25" ></textarea>
    <hr>

    <script type='text/javascript' defer>
    var statusElement = document.getElementById('status');
    var progressElement = document.getElementById('progress');
    var spinnerElement = document.getElementById('spinner');

    window.buffer_stdout = ""
    window.flushed_stdout = false

    async function boot() {


        function fnc_stdout(code) {

            var flush = (code == 4)

            if (flush) {
                flushed_stdout = true
            } else {
                if (code == 10) {
                    if (flushed_stdout) {
                        flushed_stdout = false
                        return
                    }

                    buffer_stdout += "\r\n";
                    flush = true
                }
                flushed_stdout = false
            }

            if (buffer_stdout != "") {
                if (flush) {
                    if (buffer_stdout.startsWith(sixel_prefix)) {
                        console.info("[sixel image]");
                        vm.vt.sixel(buffer_stdout);
                    } else {
                        if (buffer_stdout.startsWith("Looks like you are rendering"))
                            return;

                        vm.vt.xterm.write( b_utf8(buffer_stdout) )
                    }
                    buffer_stdout = ""
                    return
                }
            }
            if (!flush)
                buffer_stdout += String.fromCharCode(code);
        }


        function fnc_stderr(c) {
            if (!stderr_on) {
                stderr_on = true
                vm.vt.xterm.write("\x1B[1;3;31m")
            }
            if (c==10) {
                if (stderr_on) {
                    stderr_on = false
                    vm.vt.xterm.write('\x1B[0m')
                }
                vm.vt.xterm.write("\r\n")
            } else
                vm.vt.xterm.write( String.fromCharCode(c) )
        }

       function fnc_stdin() {
            if (test_data.length>0) {
                const c = test_data.shift()
                return c
            }
    // should never happen, blocking !
            console.error("pump", "EOF")
            return null;
        }

        window.stderr_on = false
        window.fnc_stdout = fnc_stdout
        window.fnc_stderr = fnc_stderr
        window.fnc_stdin = fnc_stdin


        window.test_step = 0
        window.test_data = []



        const text_codec = new TextDecoder()
        const sixel_prefix = String.fromCharCode(27)+"Pq"

        function b_utf8(s) {
            var ary = []
            for ( var i=0; i<s.length; i+=1 ) {
                ary.push( s.substr(i,1).charCodeAt(0) )
            }
            return text_codec.decode(  new Uint8Array(ary) )
        }

        function test_drive(step) {
            var data = null
            switch (test_step) {
                case 0:
                    data = "SHOW client_encoding;";
                    break

                case 1:
                    data = "SELECT now();"
                    break

                case 2:
                    data = "CREATE EXTENSION vector;"
                    break

                case 3:
                    data = "SELECT * FROM pg_extension;"
                    break
            }

            if (data!=null) {
                test_step++
                console.log("SQL:", data)
                vm.readline(data+"\n\n")
/*
                for (const c of Array.from(data + "\n\n")) {
                    const charcode = c.codePointAt(0)
                    if (charcode < 0x80) {
                        test_data.push(charcode)
                    } else {

                        if (charcode < 0x800) {
                           test_data.push(0xc0 | (charcode >> 6), 0x80 | (charcode & 0x3f));
                        }  else if (charcode < 0xd800 || charcode >= 0xe000) {
                            test_data.push(0xe0 | (charcode >> 12),
                                  0x80 | ((charcode>>6) & 0x3f),
                                  0x80 | (charcode & 0x3f));
                        } else {
                            // surrogate pair
                            console.error("UTF-16 not supported");
                        }
                    }
                }
*/
                setTimeout(test_drive, 2000);
            } else {
                console.log("SQL:End")
            }

        }


        function prerun() {
            console.log("prerun(js)")
        }

        function postrun() {
            console.log("postrun")
            setTimeout(test_drive, 3000)
        }


        var Module = {

            config : {
                cdn : "https://pygame-web.github.io/archives/0.9/",
            },

            print: (()=>{
              var element = document.getElementById('output');
              if (element) element.value = ''; // clear browser cache
              return (...args) => {
                var text = args.join(' ');
                // These replacements are necessary if you render to raw HTML
                //text = text.replace(/&/g, "&amp;");
                //text = text.replace(/</g, "&lt;");
                //text = text.replace(/>/g, "&gt;");
                //text = text.replace('\n', '<br>', 'g');
                console.log(text);
                if (element) {
                  element.value += text + "\n";
                  element.scrollTop = element.scrollHeight; // focus on bottom
                }
              };

            })(),

            canvas: (() => {
              var canvas = document.getElementById('canvas');

              // As a default initial behavior, pop up an alert when webgl context is lost. To make your
              // application robust, you may want to override this behavior before shipping!
              // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
              canvas.addEventListener("webglcontextlost", (e) => { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

              return canvas;
            })(),
    /*
            stdin : fnc_stdin,
    */
            stdout : fnc_stdout,
            stderr : fnc_stderr,

            preRun : [ prerun ],
            postRun : [ postrun ],

            locateFile : function(path, prefix) {
                console.log("locateFile: "+path+' '+prefix);
                return prefix + path;
            },

            setStatus: (text) => {
              if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
              if (text === Module.setStatus.last.text) return;
              var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
              var now = Date.now();
              if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
              Module.setStatus.last.time = now;
              Module.setStatus.last.text = text;
              if (m) {
                text = m[1];
                progressElement.value = parseInt(m[2])*100;
                progressElement.max = parseInt(m[4])*100;
                progressElement.hidden = false;
                spinnerElement.hidden = false;
              } else {
                progressElement.value = null;
                progressElement.max = null;
                progressElement.hidden = true;
                if (!text) spinnerElement.hidden = true;
              }
              statusElement.innerHTML = text;
            },
            totalDependencies: 0,
            monitorRunDependencies: (left) => {
              this.totalDependencies = Math.max(this.totalDependencies, left);
              Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            },

            readline : function(line) {
                const ud = { "type" : "stdin", "data" : line }
                if (window.worker) {
                    window.worker.postMessage({ target: 'custom', userData: ud });
                } else {
                    window.Module.postMessage(ud);
                }
            }
          };



          Module.setStatus('Downloading...');
          window.onerror = () => {
            Module.setStatus('Exception thrown, see JavaScript console');
            spinnerElement.style.display = 'none';
            Module.setStatus = (text) => {
              if (text) console.error('[post-exception status] ' + text);
            };
          };

        window.vm = Module

        const { WasmTerminal } = await /**/ import("./vtx.js")

        window.vm.vt = new WasmTerminal("repl",132,32,12)

        window.Module = await initModule(vm)
    }

    window.addEventListener("load", boot )

    </script>

    <script type=module>
        import initModule from "./postgres.js";
        window.initModule = initModule //(Module)
    </script>

<!--
    {{{ SCRIPT }}}
-->
  </body>
</html>
